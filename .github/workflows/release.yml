name: Release

on:
  push:
    branches: [main]
    paths: [package.json]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check:
    runs-on: "ubuntu-latest"
    outputs:
      should-release: ${{ steps.version-check.outputs.changed == 'true' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"
        with:
          fetch-depth: 2

      - name: "Check version change"
        id: "version-check"
        run: |
          OLD_VERSION=$(git show HEAD~1:package.json 2>/dev/null | jq -r '.version' || echo "")
          NEW_VERSION=$(jq -r '.version' package.json)
          if [ "$OLD_VERSION" != "$NEW_VERSION" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Version changed: $OLD_VERSION -> $NEW_VERSION"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "Version unchanged: $NEW_VERSION"
          fi

  release:
    needs: check
    if: needs.check.outputs.should-release == 'true'
    runs-on: "ubuntu-latest"
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"

      - name: "Build"
        id: "build"
        uses: "docker://ghcr.io/rerigferl/vpm-packager@sha256:8952f952108c77bff994c7e013ab26a32d768189d2f93e7fe35ad58b00ce59ea"
        with:
          args: "-z -u"

      - name: "Create Release"
        uses: "softprops/action-gh-release@v2"
        if: steps.build.outputs.package-version != '0.0.0'
        with:
          tag_name: ${{ steps.build.outputs.package-version }}
          draft: true
          generate_release_notes: true
          files: |
            ${{ steps.build.outputs.zip-path }}
            ${{ steps.build.outputs.unitypackage-path }}
            ${{ steps.build.outputs.manifest-path }}
